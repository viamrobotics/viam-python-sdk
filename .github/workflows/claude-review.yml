name: Claude Code Review

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # --- Resolve PR data for auto-review ---
  resolve-pr:
    permissions:
      contents: read
    if: >-
      github.repository_owner == 'viamrobotics' &&
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'claude/')
    runs-on: ubuntu-latest
    outputs:
      pr_found: ${{ steps.pr.outputs.found }}
      pr_number: ${{ steps.pr.outputs.number }}
      pr_title: ${{ steps.pr.outputs.title }}
      branch: ${{ steps.pr.outputs.branch }}
    steps:
      - name: Find PR for branch
        id: pr
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const branch = context.payload.workflow_run.head_branch;
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (pulls.length === 0) {
              core.info('No open PR found for branch ' + branch);
              core.setOutput('found', 'false');
              return;
            }

            const pr = pulls[0];
            core.setOutput('found', 'true');
            core.setOutput('number', String(pr.number));
            core.setOutput('title', pr.title);
            core.setOutput('branch', branch);

  # --- Auto-review after CI passes on claude/* branch ---
  auto-review:
    needs: resolve-pr
    if: needs.resolve-pr.outputs.pr_found == 'true'
    # viamrobotics/claude-ci-workflows@v1.10.1
    uses: viamrobotics/claude-ci-workflows/.github/workflows/claude-auto-review.yml@380cb677633bdc378a17da1c372cb72272636f8e
    with:
      pr_number: ${{ needs.resolve-pr.outputs.pr_number }}
      pr_title: ${{ needs.resolve-pr.outputs.pr_title }}
      branch: ${{ needs.resolve-pr.outputs.branch }}
      install_command: 'pip install uv && make install'
      allowed_tools: 'Edit,Read,Write,Glob,Grep,mcp__github_inline_comment__create_inline_comment,Bash(uv run make format*),Bash(uv run make lint*),Bash(git config *),Bash(git add *),Bash(git commit *),Bash(git push *),Bash(git status*),Bash(git diff*),Bash(git -C * diff*),Bash(git log*),Bash(git checkout *),Bash(git branch *),Bash(git rev-parse *),Bash(git fetch *),Bash(gh pr review*),Bash(gh pr comment*),Bash(gh pr diff*),Bash(gh pr view*)'
      extra_review_instructions: |
        - Ensure src/viam/gen/ was not modified.
        - If you fix issues, run `uv run make format` then `uv run make lint`.
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
      SLACK_AI_WORKFLOW_ALERT_WEBHOOK_URL: ${{ secrets.SLACK_AI_WORKFLOW_ALERT_WEBHOOK_URL }}

  # --- On-demand review via @claude mention ---
  on-demand-review:
    if: >-
      github.repository_owner == 'viamrobotics' &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
      )
    # viamrobotics/claude-ci-workflows@v1.10.1
    uses: viamrobotics/claude-ci-workflows/.github/workflows/claude-on-demand-review.yml@380cb677633bdc378a17da1c372cb72272636f8e
    with:
      install_command: 'pip install uv && make install'
      allowed_tools: 'Read,Glob,Grep,mcp__github_inline_comment__create_inline_comment,Bash(git diff*),Bash(git -C * diff*),Bash(git log*),Bash(git status*),Bash(git rev-parse *),Bash(git fetch *),Bash(gh pr diff*),Bash(gh pr view*)'
      extra_review_instructions: |
        - Ensure src/viam/gen/ was not modified.
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
